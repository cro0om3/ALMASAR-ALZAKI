# النشر على Vercel والربط بين الوثائق — شرح تفصيلي

## 1. الصورة العامة بعد الرفع على Vercel

عند رفع المشروع على Vercel يحدث التالي:

- **الكود:** يُبنى على سيرفرات Vercel ويُشغَّل كـ **Serverless Functions** (دوال سيرفرلس).
- **الواجهة:** كل صفحة (مثل `/quotations`, `/invoices`) تُعرض من نفس الدومين الذي يعطيك إياه Vercel (مثل `your-app.vercel.app`).
- **الـ API:** مسارات مثل `/api/quotations` و `/api/invoices` تصبح **دوال سيرفرلس**؛ كل طلب (Request) يشغّل الدالة مرة ثم تنتهي.
- **قاعدة البيانات:** تبقى **خارج Vercel** — عندك Supabase في السحابة، والمشروع يتصل بها عبر الإنترنت باستخدام متغيرات البيئة.

الربط بين الكوتيشن وأمر الشراء والفاتورة والإيصال **لا يتغيّر**؛ هو مخزّن في قاعدة البيانات (Supabase) وليس في السيرفر. لذلك نفس الربط يعمل محلياً وعلى Vercel ما دام المشروع يستخدم نفس قاعدة البيانات.

---

## 2. كيف يتم الربط تقنياً؟

### أين تُخزَن الروابط؟

كل الروابط بين الوثائق مخزنة في **Supabase** (PostgreSQL):

| الجدول           | الحقل الذي يربط        | يربط بـ        |
|------------------|-------------------------|----------------|
| `purchase_orders`| `quotationId`           | جدول `quotations` |
| `invoices`       | `quotationId` (وإن أضفت `purchaseOrderId` لاحقاً) | `quotations` / `purchase_orders` |
| `receipts`       | `invoiceId`             | جدول `invoices`   |

مثال سلسلة كاملة:

```
Quotation (id: qt_xxx)
    ↑
    │ quotationId
Purchase Order (id: po_xxx)
    ↑
    │ quotationId (أو purchaseOrderId إن وُجد في الجدول)
Invoice (id: inv_xxx)
    ↑
    │ invoiceId
Receipt (id: rcp_xxx)
```

هذه العلاقات **داخل قاعدة البيانات** (Foreign Keys). تطبيق Next.js — سواء يعمل على جهازك أو على Vercel — يقرأ ويكتب في **نفس Supabase**، لذلك الربط واحد في الحالتين.

### ماذا يحدث عند طلب من المتصفح؟

1. المستخدم يفتح الموقع (مثلاً `https://your-app.vercel.app`).
2. المتصفح يطلب الصفحة من Vercel.
3. Vercel يشغّل الدالة المناسبة (صفحة أو API).
4. الكود يستدعي `createServerClient()` من `lib/supabase-server.ts`.
5. العميل يتصل بـ **Supabase** باستخدام:
   - `NEXT_PUBLIC_SUPABASE_URL`
   - `SUPABASE_SERVICE_ROLE_KEY` (أو Anon Key + جلسة)
6. أي قراءة/كتابة (مثل إنشاء فاتورة مرتبطة بأمر شراء) تتم على **نفس الجداول ونفس الحقول**، فيبقى الربط كما هو.

---

## 3. متغيرات البيئة المطلوبة على Vercel

يجب تعبئة نفس القيم التي تستخدمها محلياً في **Vercel → المشروع → Settings → Environment Variables**:

| المتغير                         | مطلوب | الاستخدام |
|---------------------------------|-------|-----------|
| `NEXT_PUBLIC_SUPABASE_URL`      | نعم   | عنوان مشروع Supabase (يُستخدم في المتصفح والسيرفر). |
| `NEXT_PUBLIC_SUPABASE_ANON_KEY` | نعم   | المفتاح العام (للعميل والجلسات). |
| `SUPABASE_SERVICE_ROLE_KEY`     | يُفضّل | عمليات السيرفر (قراءة/كتابة بدون RLS) — الـ API يعتمد عليه. |

إذا استخدمت في المشروع:

- `DATABASE_URL` (اتصال مباشر بـ Postgres): أضفه أيضاً على Vercel إن كان الـ build أو أي سكربت يحتاجه.
- أي مفتاح لـ Storage أو Auth: أضفه بنفس الاسم المستخدم في الكود.

بدون هذه المتغيرات، الاتصال بـ Supabase يفشل والربط لا يختفي منطقياً لكن **الطلب نفسه سيرجع خطأ** لأن التطبيق لا يستطيع الوصول للبيانات.

---

## 4. البناء والنشر على Vercel

في المشروع:

- **`vercel.json`:** يحدد أمر البناء (مثلاً `npm run vercel-build`) والمنطقة (مثل `dub1`).
- **`vercel-build`** في `package.json`: يشغّل `prisma generate && next build`.

عند كل نشر:

1. Vercel يثبّت الحزم (`npm install`).
2. يشغّل `vercel-build` (Prisma generate + Next build).
3. يرفع نتيجة البناء (صفحات + دوال API).
4. عند أول طلب على أي مسار، Vercel يشغّل الدالة المعنية؛ الدالة تقرأ المتغيرات من بيئة Vercel وتتصل بـ Supabase.

الربط بين Quotation → PO → Invoice → Receipt **لا يعتمد على خطوة البناء**؛ يعتمد فقط على أن الكود عند التشغيل يجد متغيرات Supabase صحيحة ويتصل بنفس المشروع (نفس الـ URL ونفس المفتاح).

---

## 5. الفرق بين التشغيل المحلي و Vercel (من ناحية الربط)

| الجانب              | محلي (localhost)        | على Vercel                    |
|---------------------|--------------------------|-------------------------------|
| مكان تشغيل الكود    | جهازك                   | سيرفرات Vercel (سيرفرلس)     |
| قاعدة البيانات      | Supabase (سحابة)        | **نفس** Supabase (سحابة)     |
| الربط بين الوثائق   | في Supabase             | **نفس** الجداول والحقول      |
| متغيرات البيئة      | من `.env.local`         | من Vercel Environment Variables |

الخلاصة: **الربط واحد**؛ الفرق فقط أين يُنفَّذ كود Next.js (محلي vs Vercel) وكيف تُحمَّل متغيرات البيئة. البيانات والعلاقات تبقى في Supabase.

---

## 6. ملخص سريع: هل الربط يتغيّر بعد الرفع؟

- **لا.** ربط الكوتيشن بأمر الشراء والفاتورة بالإيصال مخزّن في قاعدة البيانات (Supabase).
- عند الرفع على Vercel تحتاج فقط:
  - تعبئة متغيرات البيئة (Supabase URL + Keys) في إعدادات المشروع.
  - استخدام **نفس مشروع Supabase** (نفس الـ URL ونفس المفاتيح) الذي تستخدمه محلياً إن أردت نفس البيانات والربط.
- بعد ذلك، أي عملية إنشاء/عرض/تعديل للوثائق من الموقع المنشور على Vercel ستقرأ وتكتب من نفس الجداول، فيبقى الربط يعمل بنفس الطريقة التي تعمل بها محلياً.

---

## 7. إضافة متغيرات البيئة عبر السكربت (بدون مشاركة التوكنز)

**مهم:** لا تضع **أبداً** التوكنز أو مفاتيح API أو كلمات السر في المحادثة أو في ملفات مرفوعة على Git. استخدم ملفاً محلياً فقط (مثل `.env.vercel`) وهو مُدرج في `.gitignore`.

### الخطوات الآمنة

1. **إنشاء توكن Vercel**
   - ادخل إلى [Vercel](https://vercel.com) → **Settings** → **Tokens** → **Create**.
   - اختر اسمًا للتوكن واعطِه الصلاحيات المطلوبة (مثلاً Full Account أو محدودة للمشروع).
   - انسخ التوكن **مرة واحدة** واحفظه في مكان آمن (مثلاً مدير كلمات السر).

2. **إعداد ملف محلي للمتغيرات**
   - انسخ الملف النموذجي:  
     `cp .env.vercel.example .env.vercel`
   - افتح `.env.vercel` وعبّئ القيم:
     - `VERCEL_TOKEN` = التوكن الذي أنشأته أعلاه.
     - `VERCEL_PROJECT_NAME` = اسم المشروع على Vercel (مثلاً `uncle-website-system`).
     - إذا المشروع تحت Team: `VERCEL_TEAM_ID` = معرّف الفريق.
     - بقية المتغيرات: `NEXT_PUBLIC_SUPABASE_URL`, `NEXT_PUBLIC_SUPABASE_ANON_KEY`, `SUPABASE_SERVICE_ROLE_KEY` (نفس قيم Supabase التي تستخدمها محلياً).

3. **تشغيل سكربت إضافة المتغيرات**
   - من جذر المشروع:  
     `node scripts/vercel-add-env.js`
   - السكربت يقرأ `.env.vercel` ويضيف كل المتغيرات (ما عدا `VERCEL_TOKEN` و `VERCEL_PROJECT_NAME` و `VERCEL_TEAM_ID`) إلى المشروع على Vercel عبر الـ API.
   - التوكن يُستخدم فقط على جهازك ولا يظهر في المحادثة ولا يُرفع مع المشروع.

4. **الرفع الأول للمشروع**
   - إما ربط الريبو من Vercel: **Add New Project** → اختر الريبو → Deploy (وسيستخدم المتغيرات التي أضفتها).
   - أو من الطرفية: `npx vercel --prod` (بعد تثبيت Vercel CLI وتسجيل الدخول).

بهذه الطريقة تعطي "صلاحيات" للتوكن فقط على جهازك داخل `.env.vercel`، ولا تحتاج أن تشارك التوكن أو أي مفتاح سري في المحادثة.
